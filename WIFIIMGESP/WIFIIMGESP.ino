#include "FastLED.h"
#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>

#define LED_PIN 4

#define x 12
#define y 12

ESP8266WebServer server(80);

CRGB screen[x][y]; 
CRGB screen1D[x*y];

void to1D(CRGB from2D[x][y])
{
  int k = 0;
   for(int i = 0; i < x; i++)
   {
    if(i % 2 == 0)
    {
      for(int j = 0; j < y; j++)
      {
        screen1D[k] = from2D[i][j];
        k++;
      }
    }
    else 
    {
      for(int j = y-1; j >= 0; j--)
      {
        screen1D[k] = from2D[i][j];
        k++;   
      }
     }
   }
}

bool IsStart = true;
int anim = 0;

void startImg() 
{
  if(anim == 0)
  {
    uint8_t hearth[x][y][3] =
    {
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,141,204},{0,141,204},{0,142,205},{0,143,205},{0,144,206},{0,142,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,141,204},{0,140,204},{0,142,205},{0,143,205},{0,143,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,151,209},{226,241,250},{197,228,243},{0,141,204},{0,140,204}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,147,207},{208,235,246},{238,248,252},{0,138,203},{0,140,204}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,143,205},{0,162,213},{0,150,209},{0,134,201},{0,138,203}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,143,205},{0,144,206},{0,134,201},{0,135,202}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,141,204},{0,135,201}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,140,204}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205}}
    };//картинка
    for(int i = 0; i < x; i++)
    {
      for(int j = 0; j < y; j++)
      {
        screen[i][j] = CRGB(hearth[i][j][0],hearth[i][j][1],hearth[i][j][2]);
      } 
    }
  }
  if(anim == 1)
  {
    uint8_t hearth[x][y][3] =
    {
    {{0,142,205},{0,142,205},{0,136,202},{0,135,202},{0,138,203},{0,139,203},{0,141,204},{0,142,205},{0,143,205},{0,144,206},{0,142,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,139,203},{0,133,201},{0,133,201},{0,135,202},{0,138,203},{0,140,204},{0,142,205},{0,143,205},{0,143,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,143,205},{0,151,208},{112,193,228},{255,255,255},{0,148,208},{33,171,217},{242,249,253},{197,228,243},{0,141,204},{0,140,204}},
    {{0,142,205},{0,142,205},{0,142,205},{0,145,206},{0,162,213},{253,255,255},{92,186,224},{92,186,224},{255,255,255},{240,248,252},{0,138,203},{0,140,204}},
    {{0,142,205},{0,142,205},{0,142,205},{0,143,205},{0,141,205},{215,237,247},{225,242,249},{0,151,209},{89,185,224},{0,152,209},{0,134,201},{0,138,203}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,145,207},{33,172,217},{254,255,255},{225,242,249},{81,183,223},{0,150,209},{0,131,200},{0,135,202}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,148,208},{36,170,217},{216,238,248},{255,255,255},{255,255,255},{0,128,198},{0,132,200}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,146,207},{0,138,203},{0,158,211},{73,180,221},{0,125,196},{0,130,199}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,145,206},{0,150,209},{0,131,200},{0,131,200}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,141,204},{0,137,202}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205}},
    {{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205},{0,142,205}}
    };//картинка
    for(int i = 0; i < x; i++)
    {
      for(int j = 0; j < y; j++)
      {
        screen[i][j] = CRGB(hearth[i][j][0],hearth[i][j][1],hearth[i][j][2]);
      } 
    }
  }
  if(anim == 2)
  {
    uint8_t hearth[x][y][3] =
    {
    {{5,116,191},{19,124,193},{25,128,195},{37,134,198},{41,137,199},{43,138,199},{47,140,200},{49,141,201},{51,142,201},{55,144,202},{30,131,196},{5,116,191}},
    {{19,124,193},{19,125,193},{25,128,195},{29,130,196},{33,132,197},{37,134,198},{41,137,199},{45,139,200},{49,141,201},{51,142,201},{53,143,202},{28,130,196}},
    {{33,132,197},{81,159,209},{255,255,255},{89,163,211},{147,195,227},{255,255,255},{59,147,204},{99,169,214},{243,248,252},{205,227,242},{47,140,200},{43,138,199}},
    {{37,134,198},{43,138,199},{255,255,255},{147,195,227},{95,167,213},{255,255,255},{127,184,221},{127,184,221},{255,255,255},{241,247,251},{41,137,199},{45,139,200}},
    {{41,137,199},{33,132,197},{227,240,248},{215,233,244},{45,139,200},{229,241,248},{229,241,248},{65,150,205},{125,183,221},{67,151,206},{35,133,197},{41,137,199}},
    {{43,138,199},{37,134,198},{147,195,227},{255,255,255},{113,176,218},{115,178,218},{255,255,255},{229,241,248},{121,181,220},{63,149,205},{29,130,196},{37,134,198}},
    {{47,140,200},{41,137,199},{59,147,204},{229,241,248},{243,248,252},{91,164,212},{113,176,218},{227,240,248},{255,255,255},{255,255,255},{23,127,194},{31,131,196}},
    {{49,141,201},{45,139,200},{49,141,201},{89,163,211},{243,248,252},{243,248,252},{109,174,217},{35,133,197},{85,161,210},{123,182,220},{17,123,192},{27,129,195}},
    {{51,142,201},{49,141,201},{51,142,201},{53,143,202},{87,162,211},{227,240,248},{255,255,255},{227,240,248},{141,192,225},{107,173,216},{13,121,191},{25,128,195}},
    {{49,141,201},{51,142,201},{53,143,202},{47,140,200},{41,137,199},{49,141,201},{127,184,221},{211,231,243},{255,255,255},{255,255,255},{9,119,190},{21,126,194}},
    {{30,131,196},{53,143,202},{47,140,200},{41,137,199},{35,133,197},{29,130,196},{23,127,194},{17,123,192},{13,121,191},{55,144,202},{5,117,189},{14,121,192}},
    {{5,116,191},{28,130,196},{49,141,201},{45,139,200},{41,137,199},{37,134,198},{31,131,196},{27,129,195},{25,128,195},{15,122,192},{14,121,192},{5,116,191}}
    };//картинка
    for(int i = 0; i < x; i++)
    {
      for(int j = 0; j < y; j++)
      {
        screen[i][j] = CRGB(hearth[i][j][0],hearth[i][j][1],hearth[i][j][2]);
      } 
    }
  }
    anim++;
  anim%=3;
  to1D(screen);
  FastLED.show();
  server.send(200, "text/html", "Data received");
}
void loadImg() 
{
	uint8_t hearth[x][y][3] =
	{
	{{0,171,219},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,182,224},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,171,219}},
	{{0,174,220},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,174,220},{0,175,221},{0,176,221},{0,176,221},{0,174,220}},
	{{0,174,220},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,175,221},{0,196,229},{249,254,255},{0,193,229},{0,174,220},{0,176,221},{0,174,220}},
	{{0,175,220},{0,175,221},{0,175,221},{0,175,221},{0,175,221},{0,175,221},{0,174,220},{201,242,250},{250,255,255},{0,178,222},{0,174,220},{0,174,220}},
	{{0,183,224},{0,199,231},{0,202,232},{0,201,232},{0,196,230},{0,194,229},{0,185,225},{149,231,244},{255,255,255},{175,236,247},{0,176,221},{0,172,219}},
	{{0,191,228},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{180,237,247},{0,176,221}},
	{{0,191,228},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{255,255,255},{190,239,248},{0,176,221}},
	{{0,182,223},{55,214,239},{15,213,237},{3,209,236},{66,216,239},{57,215,239},{0,197,230},{144,229,244},{255,255,255},{164,234,246},{0,177,221},{0,172,219}},
	{{0,174,220},{0,175,221},{0,175,221},{0,175,221},{0,175,221},{0,175,221},{0,173,220},{240,251,254},{231,249,253},{0,177,221},{0,173,220},{0,174,220}},
	{{0,174,220},{0,175,221},{0,175,221},{0,175,221},{0,175,221},{0,175,221},{0,173,220},{207,244,250},{0,207,234},{0,174,220},{0,176,221},{0,174,220}},
	{{0,174,220},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,176,221},{0,174,220},{0,175,220},{0,176,221},{0,176,221},{0,174,220}},
	{{0,171,219},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,174,220},{0,171,219}}
	};//картинка
	for(int i = 0; i < x; i++)
	{
	  for(int j = 0; j < y; j++)
	  {
	    screen[i][j] = CRGB(hearth[i][j][0],hearth[i][j][1],hearth[i][j][2]);
	  } 
	}
	to1D(screen);
	FastLED.show();
	server.send(200, "text/html", "Data received");
}

String* SplitEx(String source, char splitter, int n)
{
  String buffer2 = "";
  String* result = new String[432];
  int k = 0;
  
  for (int i = 0; i < n; i++)
  {
      if (source[i] != splitter)
      {
        buffer2 += source[i];
      }
      else
      {
          result[k] = buffer2;
          buffer2 = "";
          k++;
      }
      if (i == n-1)
      {
          result[k] = buffer2;
          buffer2 = "";
          k++;
      }
  }
  return result;
}

void ImgLoad()
{
	IsStart = false;
	String str = server.arg("str");
  
	int k = 0;
  
	String* ss = SplitEx(str, ' ', str.length());

	int CL_R,CL_G,CL_B;

	for(int i = 0; i < x; i++)
	{
	    for(int j = y - 1; j > -1; j--)
	    {
	        CL_R = ss[k].toInt();
	        CL_G = ss[k+1].toInt();
	        CL_B = ss[k+2].toInt();
	     
			screen[i][j] = CRGB(uint8_t(CL_R),uint8_t(CL_G),uint8_t(CL_B));
	    	k += 3;
	    }
	}
 
	delete[] ss;
	to1D(screen);
	FastLED.show();
}

void setup() 
{
	FastLED.addLeds<WS2811, LED_PIN, GRB>(screen1D, x*y).setCorrection(TypicalLEDStrip);
	FastLED.setBrightness(150);
	startImg();

	Serial.begin(115200);
	Serial.println();
	Serial.print("Configuring access point...");
	WiFi.softAP("WI-FI-esp", "00000000");
	WiFi.begin();

	Serial.println(WiFi.softAPIP());
	server.on("/", HTTP_GET, ImgLoad);
	server.begin();
	Serial.println("HTTP server started");
}


void loop() 
{
	if(WiFi.softAPgetStationNum() == 0)
	{
    IsStart = true;
		startImg();
		delay(300);
	}
 else if(IsStart)
 {
   IsStart = false;
   loadImg();
 }
	server.handleClient();
}
